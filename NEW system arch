CREATE DATABASE IF NOT EXISTS RUMPKE_DATALAKE_RAW_DEV;
CREATE SCHEMA IF NOT EXISTS RUMPKE_DATALAKE_RAW_DEV.AS400;
CREATE SCHEMA IF NOT EXISTS RUMPKE_DATALAKE_RAW_DEV.SAP_S4;
CREATE SCHEMA IF NOT EXISTS RUMPKE_DATALAKE_RAW_DEV.FIVE9;
CREATE SCHEMA IF NOT EXISTS RUMPKE_DATALAKE_RAW_DEV.SALESFORCE;

CREATE DATABASE IF NOT EXISTS DEV_STG;

CREATE DATABASE IF NOT EXISTS DEV_FINAL;


CREATE DATABASE IF NOT EXISTS DEV_FINAL_VIEW;


-- Top-level project roles
CREATE ROLE IF NOT EXISTS RUMPKE_APP_ADMIN;
CREATE ROLE IF NOT EXISTS RUMPKE_FIVETRAN;
CREATE ROLE IF NOT EXISTS RUMPKE_DBT_DEV;
CREATE ROLE IF NOT EXISTS RUMPKE_DBT_QA;
CREATE ROLE IF NOT EXISTS RUMPKE_DBT_PROD;
CREATE ROLE IF NOT EXISTS RUMPKE_ANALYST;   -- read-only to Final Views


-- Let app admin oversee all project roles
GRANT ROLE RUMPKE_FIVETRAN  TO ROLE RUMPKE_APP_ADMIN;
GRANT ROLE RUMPKE_DBT_DEV   TO ROLE RUMPKE_APP_ADMIN;
GRANT ROLE RUMPKE_DBT_QA    TO ROLE RUMPKE_APP_ADMIN;
GRANT ROLE RUMPKE_DBT_PROD  TO ROLE RUMPKE_APP_ADMIN;
GRANT ROLE RUMPKE_ANALYST   TO ROLE RUMPKE_APP_ADMIN;

-- (Optional) Attach to SYSADMIN for convenience
GRANT ROLE RUMPKE_APP_ADMIN TO ROLE SYSADMIN;


CREATE WAREHOUSE IF NOT EXISTS WH_INGEST_XS
  WITH WAREHOUSE_SIZE = 'XSMALL' AUTO_SUSPEND = 60 AUTO_RESUME = TRUE INITIALLY_SUSPENDED = TRUE;
CREATE WAREHOUSE IF NOT EXISTS WH_DBT_DEV_S
  WITH WAREHOUSE_SIZE = 'XSMALL' AUTO_SUSPEND = 60 AUTO_RESUME = TRUE INITIALLY_SUSPENDED = TRUE;
CREATE WAREHOUSE IF NOT EXISTS WH_DBT_QA_M
  WITH WAREHOUSE_SIZE = 'XSMALL' AUTO_SUSPEND = 60 AUTO_RESUME = TRUE INITIALLY_SUSPENDED = TRUE;
CREATE WAREHOUSE IF NOT EXISTS WH_DBT_PROD_L
  WITH WAREHOUSE_SIZE = 'XSMALL' AUTO_SUSPEND = 60 AUTO_RESUME = TRUE INITIALLY_SUSPENDED = TRUE;
CREATE WAREHOUSE IF NOT EXISTS WH_BI_S
  WITH WAREHOUSE_SIZE = 'SMALL' AUTO_SUSPEND = 60 AUTO_RESUME = TRUE INITIALLY_SUSPENDED = TRUE;


GRANT USAGE, OPERATE ON WAREHOUSE WH_INGEST_XS  TO ROLE RUMPKE_FIVETRAN;
GRANT USAGE, OPERATE ON WAREHOUSE WH_DBT_DEV_S  TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE, OPERATE ON WAREHOUSE WH_DBT_QA_M   TO ROLE RUMPKE_DBT_QA;
GRANT USAGE, OPERATE ON WAREHOUSE WH_DBT_PROD_L TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE ON WAREHOUSE WH_BI_S                TO ROLE RUMPKE_ANALYST;

GRANT ROLE RUMPKE_DBT_DEV TO USER sndphari2025;
GRANT ROLE RUMPKE_DBT_DEV TO USER GFISHER900;

GRANT ROLE RUMPKE_DBT_DEV TO USER ARAYAPATI89;


GRANT USAGE ON DATABASE RUMPKE_DATALAKE_RAW_DEV TO ROLE RUMPKE_FIVETRAN;
GRANT USAGE ON ALL SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_DEV TO ROLE RUMPKE_FIVETRAN;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_DEV TO ROLE RUMPKE_FIVETRAN;


GRANT CREATE SCHEMA ON DATABASE RUMPKE_DATALAKE_RAW_DEV TO ROLE RUMPKE_FIVETRAN;
GRANT ALL PRIVILEGES ON ALL SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_DEV TO ROLE RUMPKE_FIVETRAN;
GRANT ALL PRIVILEGES ON FUTURE SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_DEV TO ROLE RUMPKE_FIVETRAN;
GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON ALL TABLES IN DATABASE RUMPKE_DATALAKE_RAW_DEV TO ROLE RUMPKE_FIVETRAN;
GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE RUMPKE_DATALAKE_RAW_DEV TO ROLE RUMPKE_FIVETRAN;





GRANT USAGE ON DATABASE DEV_STG TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE ON ALL SCHEMAS IN DATABASE DEV_STG TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE DEV_STG TO ROLE RUMPKE_DBT_DEV;
GRANT CREATE SCHEMA ON DATABASE DEV_STG TO ROLE RUMPKE_DBT_DEV;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE DEV_STG TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE DEV_STG TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE DEV_STG TO ROLE RUMPKE_DBT_DEV;




GRANT USAGE ON DATABASE DEV_FINAL TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE ON ALL SCHEMAS IN DATABASE DEV_FINAL TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE DEV_FINAL TO ROLE RUMPKE_DBT_DEV;

GRANT CREATE SCHEMA ON DATABASE DEV_FINAL TO ROLE RUMPKE_DBT_DEV;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE DEV_FINAL TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE DEV_FINAL TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE DEV_FINAL TO ROLE RUMPKE_DBT_DEV;


GRANT USAGE ON DATABASE DEV_FINAL_VIEW TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE ON ALL SCHEMAS IN DATABASE DEV_FINAL_VIEW  TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE DEV_FINAL_VIEW  TO ROLE RUMPKE_DBT_DEV;

GRANT CREATE SCHEMA ON DATABASE DEV_FINAL_VIEW TO ROLE RUMPKE_DBT_DEV;

GRANT USAGE, CREATE MATERIALIZED VIEW ON ALL SCHEMAS IN DATABASE DEV_FINAL_VIEW TO ROLE RUMPKE_DBT_DEV;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE DEV_FINAL_VIEW  TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE DEV_FINAL_VIEW  TO ROLE RUMPKE_DBT_DEV;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE DEV_FINAL_VIEW  TO ROLE RUMPKE_DBT_DEV;




-- ========================
-- Databases & Schemas
-- ========================
CREATE DATABASE IF NOT EXISTS RUMPKE_DATALAKE_RAW_PROD;
CREATE SCHEMA IF NOT EXISTS RUMPKE_DATALAKE_RAW_PROD.AS400;
CREATE SCHEMA IF NOT EXISTS RUMPKE_DATALAKE_RAW_PROD.SAP_S4;
CREATE SCHEMA IF NOT EXISTS RUMPKE_DATALAKE_RAW_PROD.FIVE9;
CREATE SCHEMA IF NOT EXISTS RUMPKE_DATALAKE_RAW_PROD.SALESFORCE;

CREATE DATABASE IF NOT EXISTS QA_STG;
CREATE DATABASE IF NOT EXISTS QA_FINAL;
CREATE DATABASE IF NOT EXISTS QA_FINAL_VIEW;


-- ========================
-- Roles
-- ========================
-- (already exist globally, just re-use)
-- RUMPKE_APP_ADMIN
-- RUMPKE_FIVETRAN
-- RUMPKE_DBT_QA
-- RUMPKE_ANALYST

-- Ensure QA dbt role is under app admin
GRANT ROLE RUMPKE_DBT_QA TO ROLE RUMPKE_APP_ADMIN;


-- ========================
-- Warehouses
-- ========================
CREATE WAREHOUSE IF NOT EXISTS WH_DBT_QA_M
  WITH WAREHOUSE_SIZE = 'XSMALL' AUTO_SUSPEND = 60 AUTO_RESUME = TRUE INITIALLY_SUSPENDED = TRUE;

-- Grants to QA dbt role
GRANT USAGE, OPERATE ON WAREHOUSE WH_DBT_QA_M TO ROLE RUMPKE_DBT_QA;


-- ========================
-- Raw (QA) Permissions
-- ========================
GRANT USAGE ON DATABASE RUMPKE_DATALAKE_RAW_QA TO ROLE RUMPKE_FIVETRAN;
GRANT USAGE ON ALL SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_QA TO ROLE RUMPKE_FIVETRAN;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_QA TO ROLE RUMPKE_FIVETRAN;

GRANT CREATE SCHEMA ON DATABASE RUMPKE_DATALAKE_RAW_QA TO ROLE RUMPKE_FIVETRAN;
GRANT ALL PRIVILEGES ON ALL SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_QA TO ROLE RUMPKE_FIVETRAN;
GRANT ALL PRIVILEGES ON FUTURE SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_QA TO ROLE RUMPKE_FIVETRAN;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON ALL TABLES IN DATABASE RUMPKE_DATALAKE_RAW_QA TO ROLE RUMPKE_FIVETRAN;
GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE RUMPKE_DATALAKE_RAW_QA TO ROLE RUMPKE_FIVETRAN;


-- ========================
-- QA STG
-- ========================
GRANT USAGE ON DATABASE QA_STG TO ROLE RUMPKE_DBT_QA;
GRANT USAGE ON ALL SCHEMAS IN DATABASE QA_STG TO ROLE RUMPKE_DBT_QA;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE QA_STG TO ROLE RUMPKE_DBT_QA;
GRANT CREATE SCHEMA ON DATABASE QA_STG TO ROLE RUMPKE_DBT_QA;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE QA_STG TO ROLE RUMPKE_DBT_QA;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE QA_STG TO ROLE RUMPKE_DBT_QA;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE QA_STG TO ROLE RUMPKE_DBT_QA;


-- ========================
-- QA FINAL
-- ========================
GRANT USAGE ON DATABASE QA_FINAL TO ROLE RUMPKE_DBT_QA;
GRANT USAGE ON ALL SCHEMAS IN DATABASE QA_FINAL TO ROLE RUMPKE_DBT_QA;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE QA_FINAL TO ROLE RUMPKE_DBT_QA;

GRANT CREATE SCHEMA ON DATABASE QA_FINAL TO ROLE RUMPKE_DBT_QA;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE QA_FINAL TO ROLE RUMPKE_DBT_QA;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE QA_FINAL TO ROLE RUMPKE_DBT_QA;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE QA_FINAL TO ROLE RUMPKE_DBT_QA;


-- ========================
-- QA FINAL VIEW
-- ========================
GRANT USAGE ON DATABASE QA_FINAL_VIEW TO ROLE RUMPKE_DBT_QA;
GRANT USAGE ON ALL SCHEMAS IN DATABASE QA_FINAL_VIEW TO ROLE RUMPKE_DBT_QA;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE QA_FINAL_VIEW TO ROLE RUMPKE_DBT_QA;

GRANT CREATE SCHEMA ON DATABASE QA_FINAL_VIEW TO ROLE RUMPKE_DBT_QA;

GRANT USAGE, CREATE MATERIALIZED VIEW ON ALL SCHEMAS IN DATABASE QA_FINAL_VIEW TO ROLE RUMPKE_DBT_QA;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE QA_FINAL_VIEW TO ROLE RUMPKE_DBT_QA;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE QA_FINAL_VIEW TO ROLE RUMPKE_DBT_QA;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE QA_FINAL_VIEW TO ROLE RUMPKE_DBT_QA;


GRANT ROLE RUMPKE_DBT_QA TO USER sndphari2025;


-- Allow the role to see the database
GRANT USAGE ON DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;

-- Existing schemas
GRANT USAGE ON ALL SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;

-- Existing objects
GRANT SELECT ON ALL TABLES IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;
GRANT SELECT ON ALL VIEWS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;
GRANT SELECT ON ALL MATERIALIZED VIEWS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;

-- Future objects
GRANT SELECT ON FUTURE TABLES IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;
GRANT SELECT ON FUTURE VIEWS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;
GRANT SELECT ON FUTURE MATERIALIZED VIEWS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_APP_ADMIN;




CREATE DATABASE IF NOT EXISTS PROD_STG;
CREATE DATABASE IF NOT EXISTS PROD_FINAL;
CREATE DATABASE IF NOT EXISTS PROD_FINAL_VIEW;


-- ========================
-- Roles
-- ========================
-- (already exist globally, just re-use)
-- RUMPKE_APP_ADMIN
-- RUMPKE_FIVETRAN
-- RUMPKE_DBT_QA
-- RUMPKE_ANALYST

-- Ensure QA dbt role is under app admin
GRANT ROLE RUMPKE_DBT_PROD TO ROLE RUMPKE_APP_ADMIN;




-- ========================
-- Raw (PROD) Permissions
-- ========================
GRANT USAGE ON DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_FIVETRAN;
GRANT USAGE ON ALL SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_FIVETRAN;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_FIVETRAN;

GRANT CREATE SCHEMA ON DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_FIVETRAN;
GRANT ALL PRIVILEGES ON ALL SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_FIVETRAN;
GRANT ALL PRIVILEGES ON FUTURE SCHEMAS IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_FIVETRAN;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON ALL TABLES IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_FIVETRAN;
GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE RUMPKE_DATALAKE_RAW_PROD TO ROLE RUMPKE_FIVETRAN;


-- ========================
-- PROD STG
-- ========================
GRANT USAGE ON DATABASE PROD_STG TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE ON ALL SCHEMAS IN DATABASE PROD_STG TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE PROD_STG TO ROLE RUMPKE_DBT_PROD;
GRANT CREATE SCHEMA ON DATABASE PROD_STG TO ROLE RUMPKE_DBT_PROD;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE PROD_STG TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE PROD_STG TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE PROD_STG TO ROLE RUMPKE_DBT_PROD;


-- ========================
-- PROD FINAL
-- ========================
GRANT USAGE ON DATABASE PROD_FINAL TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE ON ALL SCHEMAS IN DATABASE PROD_FINAL TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE PROD_FINAL TO ROLE RUMPKE_DBT_PROD;

GRANT CREATE SCHEMA ON DATABASE PROD_FINAL TO ROLE RUMPKE_DBT_PROD;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE PROD_FINAL TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE PROD_FINAL TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE PROD_FINAL TO ROLE RUMPKE_DBT_PROD;


-- ========================
-- PROD FINAL VIEW
-- ========================
GRANT USAGE ON DATABASE PROD_FINAL_VIEW TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE ON ALL SCHEMAS IN DATABASE PROD_FINAL_VIEW TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE PROD_FINAL_VIEW TO ROLE RUMPKE_DBT_PROD;

GRANT CREATE SCHEMA ON DATABASE PROD_FINAL_VIEW TO ROLE RUMPKE_DBT_PROD;

GRANT USAGE, CREATE MATERIALIZED VIEW ON ALL SCHEMAS IN DATABASE PROD_FINAL_VIEW TO ROLE RUMPKE_DBT_PROD;

GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES
  ON FUTURE TABLES IN DATABASE PROD_FINAL_VIEW TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE, CREATE VIEW ON ALL SCHEMAS IN DATABASE PROD_FINAL_VIEW TO ROLE RUMPKE_DBT_PROD;
GRANT USAGE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE PROD_FINAL_VIEW TO ROLE RUMPKE_DBT_PROD;


GRANT ROLE RUMPKE_DBT_PROD TO USER sndphari2025;







DROP DATABASE IF EXISTS RUMPKE_DATALAKE_RAW_QA;
